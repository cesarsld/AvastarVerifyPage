<!doctype html>

<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TipBot Deposit Page</title>
  <meta name="description" content="Allows Discord users to deposit erc-20 tokens to their TipWallets">
  <meta name="author" content="Owl">
  <meta name="theme-color" content="#def2d9">
  <link rel="stylesheet" href="css/styles.css">
</head>

<body id="body">

    <div id="d-box" class="dialog-box">
        <h2 id="d-name" class="dialog-box__name">Hello!</h2>
        <p>You've landed on the AvastarBot wallet bonding page!<br>
            Click on the button to generate a signature! <br>
            Do not worry, not funds or assets will be taken away.<br>
        </p>
        </p>
        <button type="button" id="start-button" class="button">Generate signature</button>


    </div>


    <div id="d-box1" class="final-box" >
        <p>Your Signature will copied to your clipboard once you've signed the message<br>
            Please paste it as a message to the AvastarBot<br>
        </p>
        <div id="d-box2" class="final-box1">
        </div>


    </div>

     <script type="text/javascript" src="js/front.js"></script>
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/eth-sig-util@2.5.3/index.min.js"></script>
     <script>
        var discordId;
        var tokenAddress;
        var userAddress = 'boo';
        var statedAddress = 'boo'
        var sig = {};

        var d = window.location.href;
        var url = new URL(d);
        statedAddress = url.searchParams.get("address");
        discordId = url.searchParams.get("discordId");

        $(document).ready(async function() {
            // Modern dapp browsers...
            if (window.ethereum) {
                window.web3 = new Web3(ethereum);
                BigNumber = web3.BigNumber;
                try {
                    // Request account access if needed
                    await ethereum.enable();
                    console.log("modern dapp browser");
                } catch (error) {
                    // User denied account access...
                    console.log("User denied ethereum account access.")
                }
            }
            // Legacy dapp browsers...
            else if (window.Web3) {
                window.Web3 = new Web3(Web3.currentProvider);
                BigNumber = Web3.BigNumber;
                // Acccounts always exposed
                console.log("legacy dapp browser");
            }
            // Non-dapp browsers...
            else {
                console.log('Non-Ethereum browser detected.');
                //since we are using our own web3.min.js
                let w3 = new Web3();
                BigNumber = w3.BigNumber;
            }
            userAddress = (await web3.eth.getAccounts())[0];
            let network = await web3.eth.net.getNetworkType();
            if (!isValidAddress(statedAddress)
                || discordId == null || !isUint64(discordId) || statedAddress.toLowerCase() != userAddress.toLowerCase())
            {
                document.getElementById("start-button").disabled = true;
                alert("Wrong stated address");
            }
        });

        document.getElementById("start-button").addEventListener('click', function(){
            generateSignature();
        });

        function generateSignature()
        {
            const msgParams = [
                {   
                    type: 'uint64',
                    name: 'DiscordId',
                    value: discordId
                },
                {
                    type: 'string',      // Any valid solidity type
                    name: 'User address',     // Any string label you want
                    value: userAddress  // The value to sign
                }
            ];

            web3.currentProvider.sendAsync({
                method: 'eth_signTypedData',
                params: [msgParams, userAddress],
                from: userAddress,
            }, function (err, result){
                document.getElementById("d-box2").innerText = "Signature copied to clipboard!;
                fallbackCopyTextToClipboard("$verify " + userAddress + " " + result.result)
            }); 
        }


        function isValidAddress(add)
        {
            var regexp = /^[0-9a-fA-F]+$/;
            if (add.startsWith('0x') &&  add.length === 42)
                if (regexp.test(add.substring(2)))
                    return  true;
            return false;
        }

        function isUint64(id)
        {
            var regexp = /^[0-9]+$/;
            if (regexp.test(id))
                return  true;
            return false;
        }

        function trim (s, c) {
            if (c === "]") c = "\\]";
            if (c === "\\") c = "\\\\";
            return s.replace(new RegExp(
                "^[" + c + "]+|[" + c + "]+$", "g"
            ), "");
        }

        function convertUintToReadable(str, dec)
        {
            dec = parseInt(dec);
            if (str.length <= dec)
            {
                str = str.padStart(dec, '0');
                str = "0." + str;
            }
            else
            {
                str =  str.slice(0, str.length - dec) + '.' + str.slice(str.length - dec)
            }
            str = trim(str, '0');
            if (str[str.length - 1] == '.')
            {
                str = str.substring(0, str.length - 1);
                return str;
            }
            return str;
        }

        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement("textarea");
            textArea.value = text;

            // Avoid scrolling to bottom
            textArea.style.top = "0";
            textArea.style.left = "0";
            textArea.style.position = "fixed";

            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                var successful = document.execCommand('copy');
                var msg = successful ? 'successful' : 'unsuccessful';
                console.log('Fallback: Copying text command was ' + msg);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }

            document.body.removeChild(textArea);
        }
        
     </script>
</body>
</html>


